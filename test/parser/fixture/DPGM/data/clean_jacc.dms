'*****FILE VERSION=8, DATE LAST MODIFIED=2013/12/17, KO

'use this .dms for making changes to the final DB

#include "..\job.ini"
'**************************************************************************************
'**************************************************************************************
'**************************************************************************************
'CHANGE:  TRUE/FALSE - TRUE: if have metadata to add to MDD in a include file
'                      FALSE: if no metadata to add then this will not open the MDD file
#define USING_METADATA_INCLUDE_FILES TRUE

'CHANGE:  TRUE/FALSE - TRUE: if have edits to the casedata in the edits_revisions.mrs file
'                      FALSE: if have no edits to the casedata in the edits_revisions.mrs file
#define USING_EDITS_INCLUDE_FILES TRUE

#define METADATA_IN  ".\" + INPUT_METADATA + "_UPDATE.mdd"
#define CASEDATA_IN  ".\" + INPUT_METADATA + "_FINAL.ddf"
#define METADATA_OUT ".\" + INPUT_METADATA + "_Jacc.mdd"
#define CASEDATA_OUT ".\" + INPUT_METADATA + "_Jacc.ddf"


'CHANGE AS NEEDED:  True/False where True includes weight.mrs file
#define INCLUDE_WEIGHT False

#define VERSION ""

'**************************************************************************************
'**************************************************************************************
'**************************************************************************************


InputDataSource(myInputDataSource, "Final DB")
     ConnectionString = "Provider=mrOleDB.Provider.2; _
          Data Source=mrDataFileDsc; _
          MR Init MDM Version = {..}; _
          Mr Init MDM Access = 1;_
          Initial Catalog=temp.mdd; _
          Location=temp.ddf"
     SelectQuery = "SELECT * FROM VDATA"
End InputDataSource


OutputDataSource (NewDB)
    ConnectionString="Provider=mrOleDB.Provider.2;_
    Data Source=mrDataFileDsc;_
    Location=tempOUT.ddf;MR Init Overwrite=1"
    MetaDataOutputName = "tempOUT.mdd"
End OutputDataSource


Logging(MyLog)
        path="..\logs"
        GROUP="DMGR"
        ALIAS="Tester"
        FileSize=500
End Logging


Event(OnBeforeJobStart)
     #include "..\Library\Library.mrs"
     #include "..\Library\FileFunctions.mrs"
     #include ".\assign_functions.mrs"
     sbLogTime("clean_update.dms", "Start")

     Dim oFso,adoConnection, ConnectionString, DataLinkHelper, MDM, oFile

     Set oFso = CreateObject("Scripting.FileSystemObject")

     with ofso
          if .FileExists("temp.inc") then .DeleteFile("temp.inc")
          if .FileExists("temp.ddf") then .DeleteFile("temp.ddf")
          if .FileExists("temp.mdd") then .DeleteFile("temp.mdd")
          if .FileExists("temp1.mdd") then .DeleteFile("temp1.mdd")
          if .FileExists("tempOUT.ddf") then .DeleteFile("tempOUT.ddf")
          if .FileExists("tempOUT.mdd") then .DeleteFile("tempOUT.mdd")

          If .FileExists(METADATA_OUT) Then .DeleteFile(METADATA_OUT)
          If .FileExists(CASEDATA_OUT) Then .DeleteFile(CASEDATA_OUT)

          .copyfile(METADATA_IN,  METADATA_OUT, true)
          .copyfile(CASEDATA_IN,  CASEDATA_OUT, true)

          .copyfile(METADATA_OUT,"temp.mdd",true)
          .copyfile(CASEDATA_OUT,"temp.ddf",true)
     end with

     Set MDM = CreateObject("MDM.Document")
     MDM.Open("temp.mdd")
     #include "..\functions.mrs"
     #include "..\MDD_Manipulation.mrs"
     If ofso.FileExists("jacc_metadata.mrs") Then ofso.DeleteFile("jacc_metadata.mrs")
     #include "Metadata_Jacc.mrs"
     MDM.Close()

     #define DEFCREATEFLIPPEDGRIDMETADATA "CreateFlippedGridMetadata_Revisions.mrs"
     #define DEFLISTS "Lists_Revisions.mrs"
     #define DEFMETADATA "jacc_metadata.mrs"

     '*****Start_Analysis Spark Insert FILE VERSION=1, DATE LAST MODIFIED=2012/02/01, MB UK
     ' *****************************************************************************************
     #define ADDSPARKVARIABLES False
     #define DEFSPARKMETADATA " "
     ' *****************************************************************************************
     '*****END OF Start_Analysis Spark Insert

     #define DEFEDITS "Edits_Revisions.mrs"
     #include "..\LIBRARY\DMS_CORE.mrs"

End Event


Event(OnJobEnd, "Weight the data")
'     if INCLUDE_WEIGHT then
'        #include ".\Include\Weight.mrs"
'     end if

     'Update the DDF reference in the MDD file
     dim MDM
     set MDM = dmgrJob.TableDocuments["NewDB"].DataSet.MDMDocument
     ''this may need to be adjusted to include/exclude _withopens
     MDM.Datasources.Current.DBLocation = mid(CASEDATA_OUT,find(CASEDATA_OUT,"\",,True)+1)
End Event


Event(OnAfterJobEnd)
     #include "..\Library\FileFunctions.mrs"
     dim ofso
     set ofso=createobject("scripting.filesystemobject")

     with ofso
          'Rename the temp file to match the input file names
          .copyfile("tempOUT.mdd",METADATA_OUT,true)
          .copyfile("tempOUT.ddf",CASEDATA_OUT,true)
          Debug.Log("Master database successfully updated")
          'Remove temp files
          if .FileExists("temp.inc") then .DeleteFile("temp.inc")
          if .FileExists("temp.ddf") then .DeleteFile("temp.ddf")
          if .FileExists("temp.mdd") then .DeleteFile("temp.mdd")
          if .FileExists("temp1.mdd") then .DeleteFile("temp1.mdd")
          if .FileExists("tempOUT.ddf") then .DeleteFile("tempOUT.ddf")
          if .FileExists("tempOUT.mdd") then .DeleteFile("tempOUT.mdd")
     end with

     sbLogTime("clean_update.dms", "End")
End Event


Event(OnNextCase, "Populate derived variables based on coded information")
        #include "..\Library\FileFunctions.mrs"
        #include "..\Library\Clean_Functions.mrs"
        #include "..\Library\Editing.mrs"
        #include ".\assign_functions.mrs"

        Dim cat,cat_1,cat_2
        #include "Assign_Jacc.mrs"

End Event
