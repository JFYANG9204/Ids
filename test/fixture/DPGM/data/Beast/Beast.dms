#include "..\..\job.ini"
#include "beast.ini"

Event(OnBeforeJobStart)

        #include "..\..\Library\FileFunctions.mrs"
        Dim oFso, MDM, file1
        Set oFso = CreateObject("Scripting.FileSystemObject")
        If oFso.FileExists("output\temp.inc") Then oFso.DeleteFile("output\temp.inc",True)
        If oFso.FileExists("output\temp_list.inc") Then oFso.DeleteFile("output\temp_list.inc",True)
        If oFso.FileExists("output\Txt_DelUseless.txt") Then oFso.DeleteFile("output\Txt_DelUseless.txt",True)
        If oFso.FileExists("output\CreatGrid.mrs") Then oFso.DeleteFile("output\CreatGrid.mrs",True)
        If oFso.FileExists("output\tab.mrs") Then oFso.DeleteFile("output\tab.mrs",True)
        If oFso.FileExists("output\" + INPUT_METADATA + "_BEAST_FullQes.sav") Then oFso.DeleteFile("output\" + INPUT_METADATA + "_BEAST_FullQes.sav",True)
        If oFso.FileExists("output\" + INPUT_METADATA + "_BEAST_FullQes.ddf") Then oFso.DeleteFile("output\" + INPUT_METADATA + "_BEAST_FullQes.ddf",True)
        If oFso.FileExists("output\" + INPUT_METADATA + "_BEAST_FullQes.mdd") Then oFso.DeleteFile("output\" + INPUT_METADATA + "_BEAST_FullQes.mdd",True)
        If oFso.FileExists("output\" + INPUT_METADATA + "_BEAST_FullQessav.mdd") Then oFso.DeleteFile("output\" + INPUT_METADATA + "_BEAST_FullQessav.mdd",True)
        If oFso.FileExists("output\" + INPUT_METADATA + "_BEAST.mdd") Then oFso.DeleteFile("output\" + INPUT_METADATA + "_BEAST.mdd",True)

        set MDM=CreateObject("MDM.Document")

''''''''''''''''''''''''''  Need Change  ''''''''''''''''''''''''''''''''''''''''''''
        #include "AddQes.mrs"
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

        if oFso.FileExists("output\Txt_DelUseless.txt") then
                set file1=oFso.OpenTextFile("output\Txt_DelUseless.txt",8) 'ForAppending
                If BEAST_WEIGHT = True Then file1.WriteLine(",DPWT_")
                file1.WriteLine("    from vdata where "" + GLOBALFILTER")

        end if

        oFso.copyfile("..\" + INPUT_METADATA + "_UPDATE.mdd","output\" + INPUT_METADATA + "_BEAST.mdd",true)

        dim MDM_New
        set MDM_New=createobject("MDM.Document")

        with MDM_New
'             .Contexts.Base="QUESTION"
'             .Contexts.Current="QUESTION"
             .Contexts.Base=MDD_TYPE
             .Contexts.Current=MDD_TYPE

             'Adds the LOCALE as the language to the temporary mdd
             .Languages.Add("en-GB")
             .Languages.Current="en-GB"
             
             .Join("..\" + INPUT_METADATA + "_UPDATE.mdd","",1,1)

             .sbAddToTypes(oFso,"output\temp_list.inc")
             .sbAddToFields(oFso,"output\temp.inc")

             .save("output\" + INPUT_METADATA + "_BEAST.mdd")
        end with


End Event

Metadata ("en-GB", MDD_TYPE, Label, MyInputDataSource)

''''''''''''''''''''''''''  Need Change  ''''''''''''''''''''''''''''''''''''''''''''
        #include "sbDefineList.mrs"
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

End Metadata

Event(OnNextCase, "Emit the data")

''''''''''''''''''''''''''  Need Change  ''''''''''''''''''''''''''''''''''''''''''''
        #include "EmtQes.mrs"
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

end Event

InputDataSource(MyInputDataSource, "Loading in Data")
        ConnectionString = "Provider=mrOleDB.Provider.2; _
                Data Source=mrDataFileDsc; _
                MR Init MDM Version = {}; _
                MR Init MDM Access = 1; _
                Mr Init MDM Category Names = 1; _
                Initial Catalog=output\" + INPUT_METADATA + "_BEAST.mdd; _
                Location=..\" + INPUT_METADATA + "_FINAL.ddf"
        SelectQuery = "select * from vdata where " + GLOBALFILTER
End InputDataSource


OutputDataSource(myOutputDataSource, "Exporting Data")
        ConnectionString = "Provider=mrOleDB.Provider.2; _
                Data Source=mrDataFileDsc;MR Init Overwrite=1; _
                Location=output\" + INPUT_METADATA + "_BEAST_FullQes.ddf"
        MetaDataOutputName = "output\" + INPUT_METADATA + "_BEAST_FullQes.mdd"
End OutputDataSource

'OutputDatasource(BEASTOuputDataSource, "The output data source")
'	ConnectionString = " _
'		Provider = mrOleDB.Provider.2; _
'		Persist Security Info = False; _
'		Data Source = mrSavDsc; _
'		Location = output\" + INPUT_METADATA + "_BEAST_FullQes.sav; _
'		Mode = 3; _
'		MR Init MDSC Access = 2; _
'		MR Init MDM Language = " + LOCALE + "; _
'		MR Init MDM Access = 0; _
'		MR Init MDM DataSource Use = 0; _
'		MR Init MDM Version Variable = False; _
'		MR Init Category Names = 0; _
'		MR Init Category Values = 0; _
'		MR Init Allow Dirty = True; _
'		MR Init Validation = True; _
'		MR Init Input Locale = 0; _
'		MR Init Output Locale = 0; _
'		MR Init Custom = "ExportFactors = True;LabelFormatDichotomy=%Label: %CategoryLabel;LabelFormatSingle=%Label;LabelFormatMultiple=(%FullName - %Index/%Count) %Label"; _
'		MR Init Overwrite = 1; _
'		MR Init Native Schema = False; _
'		MR Init Merge Data Elements = False"
'	MetaDataOutputName = "output\" + INPUT_METADATA + "_BEAST_FullQessav.mdd"
'	VariableOrder = "METADATAORDER"
'End OutputDatasource
